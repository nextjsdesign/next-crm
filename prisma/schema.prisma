generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

//
// ==========================
//        ENUMS
// ==========================
//

enum Role {
  admin
  technician
  receptionist
}

//
// ==========================
//        MODELS
// ==========================
//

model User {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  email     String    @unique
  password  String
  role      Role      @default(technician)
  workHours String?
  target    Int?
  bonus     Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
  isActive  Boolean   @default(true)

  devices       Device[]
  repairs       Repair[]       @relation("RepairAssignedTech")
  notes         RepairNote[]
  notifications Notification[] // Notificările userului
}

model Client {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  phone     String?
  email     String?
  address   String?
  createdAt DateTime @default(now())

  devices Device[]
}

model Settings {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  companyName String
  email       String
  phone       String
  theme       String   @default("system")
  logoUrl     String?
  tabStyle    String   @default("classic")
  updatedAt   DateTime @updatedAt
}

model Device {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  clientId String @db.ObjectId
  client   Client @relation(fields: [clientId], references: [id])

  userId String? @db.ObjectId
  user   User?   @relation(fields: [userId], references: [id])

  parentDeviceId String?

  sheetType String?
  status    String  @default("Primire")

  deviceType   String?
  brand        String?
  model        String?
  serialNumber String?

  problem     String?
  description String?
  accessories String?
  technician  String?

  priceEstimate  Float?
  advance        Float?
  warranty       String?
  priceConfirmed Boolean @default(false)

  liquidContact Boolean   @default(false)
  notes         String?
  deliveryDays  Int?
  deliveryDate  DateTime?

  receptionCondition String?
  receptionNotes     String?

  createdAt DateTime @default(now())

  repairs Repair[]
}

//
// ==========================
//          REPAIR
// ==========================
//

model Repair {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  deviceId String @db.ObjectId
  device   Device @relation(fields: [deviceId], references: [id])

  assignedTechnicianId String? @db.ObjectId
  assignedTechnician   User?   @relation("RepairAssignedTech", fields: [assignedTechnicianId], references: [id])

  takenAt    DateTime?
  status     String    @default("În lucru")
  diagnostic String?
  notes      String?

  items        RepairItem[]
  historyNotes RepairNote[]

  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt
}

model RepairItem {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  repairId String @db.ObjectId
  repair   Repair @relation(fields: [repairId], references: [id])

  kind      String
  label     String
  qty       Int    @default(1)
  unitPrice Float  @default(0)
}

//
// ==========================
//       REPAIR NOTES
// ==========================
//

model RepairNote {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  repairId String @db.ObjectId
  repair   Repair @relation(fields: [repairId], references: [id])

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  message   String
  createdAt DateTime @default(now())
}

//
// ==========================
//       NOTIFICATIONS
// ==========================
//

model Notification {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  type    String // "note-added" | "status-change" | "assign"
  message String

  deviceId String? // STRING — pentru a evita erorile ObjectId
  repairId String? // STRING — la fel

  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([repairId])
  @@index([deviceId])
}
